<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempo Practice Calculator | テンポ練習時間計算機</title>
    <meta name="description" content="段階的テンポ上昇トレーニングの総所要時間を高精度に算出するツール">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="tempo-calculator.css">

    <!-- iOS Web App Settings -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="練習計算機">
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <button type="button" id="menu-btn" class="icon-btn" title="メニュー">
                    <span class="menu-icon">≡</span>
                </button>
                <div class="logo">
                    <div class="logo-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10" />
                            <polyline points="12 6 12 12 16 14" />
                        </svg>
                    </div>
                    <h1 class="logo-text">Tempo Practice Calculator</h1>
                </div>
                <p class="tagline">練習時間計算機</p>
            </div>
        </header>

        <!-- Navigation Menu (Side Drawer) -->
        <div id="nav-overlay" class="nav-overlay"></div>
        <nav id="nav-menu" class="nav-menu">
            <div class="nav-header">
                <h2>Menu</h2>
                <button type="button" id="close-menu-btn" class="icon-btn">×</button>
            </div>
            <ul class="nav-list">
                <li>
                    <button type="button" class="nav-item active" data-target="calculator-view">
                        <span class="nav-icon">🔢</span> 練習時間計算
                    </button>
                </li>
                <li>
                    <button type="button" class="nav-item" data-target="metronome-view">
                        <span class="nav-icon">⏱️</span> メトロノーム
                    </button>
                </li>
            </ul>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Calculator View -->
            <div id="calculator-view" class="view-section active">
                <section class="calculator-section glass-card">
                    <h2 class="section-title">
                        <span class="title-icon">⚙️</span>
                        練習パラメータ設定
                    </h2>

                    <form id="calculator-form" class="form-grid">
                        <!-- Tempo Settings -->
                        <div class="form-group-container">
                            <h3 class="group-title">テンポ設定</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="startTempo">
                                        開始テンポ
                                        <span class="unit">(BPM)</span>
                                    </label>
                                    <div class="input-wrapper">
                                        <input type="number" id="startTempo" name="startTempo" value="60" min="20"
                                            max="300" step="1" required>
                                        <span class="input-icon">🎵</span>
                                    </div>
                                    <span class="hint">a: 練習開始時の速度</span>
                                </div>

                                <div class="form-group">
                                    <label for="endTempo">
                                        目標テンポ
                                        <span class="unit">(BPM)</span>
                                    </label>
                                    <div class="input-wrapper">
                                        <input type="number" id="endTempo" name="endTempo" value="120" min="20"
                                            max="400" step="1" required>
                                        <span class="input-icon">🎯</span>
                                    </div>
                                    <span class="hint">b: 最終到達テンポ</span>
                                </div>

                                <div class="form-group">
                                    <label for="stepSize">
                                        ステップ幅
                                        <span class="unit">(BPM)</span>
                                    </label>
                                    <div class="input-wrapper">
                                        <input type="number" id="stepSize" name="stepSize" value="4" min="1" max="50"
                                            step="1" required>
                                        <span class="input-icon">📈</span>
                                    </div>
                                    <span class="hint">s: 1回の加速量</span>
                                </div>
                            </div>
                        </div>

                        <!-- Practice Structure -->
                        <div class="form-group-container">
                            <h3 class="group-title">練習構造</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="beatsPerPhrase">
                                        拍子数
                                        <span class="unit">(拍)</span>
                                    </label>
                                    <div class="input-wrapper">
                                        <input type="number" id="beatsPerPhrase" name="beatsPerPhrase" value="4" min="1"
                                            max="64" step="1" required>
                                        <span class="input-icon">🎼</span>
                                    </div>
                                    <span class="hint">B: 1フレーズの長さ</span>
                                </div>

                                <div class="form-group">
                                    <label for="repetitions">
                                        反復回数
                                        <span class="unit">(回)</span>
                                    </label>
                                    <div class="input-wrapper">
                                        <input type="number" id="repetitions" name="repetitions" value="4" min="1"
                                            max="100" step="1" required>
                                        <span class="input-icon">🔄</span>
                                    </div>
                                    <span class="hint">R: 各テンポでの繰り返し</span>
                                </div>

                                <div class="form-group">
                                    <label for="sets">
                                        全体のセット数
                                        <span class="unit">(セット)</span>
                                    </label>
                                    <div class="input-wrapper">
                                        <input type="number" id="sets" name="sets" value="1" min="1" max="20" step="1"
                                            required>
                                        <span class="input-icon">📦</span>
                                    </div>
                                    <span class="hint">N: 全体の反復回数</span>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="calculate-btn">
                            <span class="btn-icon">⏱️</span>
                            計算する
                            <span class="btn-shine"></span>
                        </button>
                    </form>
                </section>

                <!-- Results Section -->
                <section id="results-section" class="results-section glass-card hidden">
                    <h2 class="section-title">
                        <span class="title-icon">📊</span>
                        計算結果
                    </h2>

                    <!-- Summary Cards -->
                    <div class="result-cards">
                        <div class="result-card primary">
                            <div class="card-header">
                                <span class="card-icon">⏱️</span>
                                <span class="card-label">総所要時間</span>
                            </div>
                            <div class="card-value" id="totalTime">--:--</div>
                            <div class="card-sub" id="totalTimeSeconds">-- 秒</div>
                        </div>

                        <div class="result-card secondary">
                            <div class="card-header">
                                <span class="card-icon">📐</span>
                                <span class="card-label">ステップ数</span>
                            </div>
                            <div class="card-value" id="stepCount">--</div>
                            <div class="card-sub">回のテンポ変更</div>
                        </div>

                        <div class="result-card tertiary">
                            <div class="card-header">
                                <span class="card-icon">🎯</span>
                                <span class="card-label">実際の終了テンポ</span>
                            </div>
                            <div class="card-value" id="actualEndTempo">--</div>
                            <div class="card-sub">BPM</div>
                        </div>
                    </div>

                    <!-- Calculation Details -->
                    <div class="calculation-details">
                        <h3 class="details-title">計算詳細</h3>

                        <div class="details-grid">
                            <div class="detail-item">
                                <span class="detail-label">厳密解（ループ計算）</span>
                                <span class="detail-value" id="exactTime">-- 秒</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">近似解（S-P公式）</span>
                                <span class="detail-value" id="approxTime">-- 秒</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">近似誤差率</span>
                                <span class="detail-value" id="errorRate">--%</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">1ステップ総拍数 (K)</span>
                                <span class="detail-value" id="totalBeatsPerStep">-- 拍</span>
                            </div>
                        </div>
                    </div>

                    <!-- Formula Display -->
                    <div class="formula-display">
                        <h3 class="formula-title">使用した数式</h3>
                        <div class="formula-box">
                            <p class="formula">T<sub>total</sub> = N × Σ<sub>k=0</sub><sup>n</sup> (60 × B × R) / (a + s
                                ×
                                k)</p>
                            <p class="formula-description">
                                総所要時間 = セット数 × 各ステップの時間の総和
                            </p>
                        </div>
                    </div>
                </section>

                <!-- Info Section -->
                <section class="info-section glass-card">
                    <h2 class="section-title">
                        <span class="title-icon">📖</span>
                        使い方
                    </h2>
                    <div class="info-content">
                        <div class="info-item">
                            <div class="info-number">1</div>
                            <div class="info-text">
                                <strong>テンポ設定</strong>で開始テンポ・終了テンポ・ステップ幅を入力
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-number">2</div>
                            <div class="info-text">
                                <strong>練習構造</strong>で拍子数・反復回数・セット数を設定
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-number">3</div>
                            <div class="info-text">
                                <strong>計算する</strong>ボタンで総所要時間を算出
                            </div>
                        </div>
                    </div>

                    <div class="tip-box">
                        <span class="tip-icon">💡</span>
                        <p>
                            <strong>ヒント:</strong> 低速域では時間が長くなります。
                            テンポと時間は<strong>反比例</strong>の関係（t ∝ 1/v）にあるため、
                            直感より実際は長くかかることがほとんどです。
                        </p>
                    </div>
                </section>
            </div> <!-- End Calculator View -->

            <!-- Metronome View -->
            <div id="metronome-view" class="view-section hidden">
                <section class="metronome-section glass-card">
                    <div class="metronome-app">
                        <!-- BPM Display -->
                        <div class="bpm-display-area">
                            <span class="bpm-label">TEMPO</span>
                            <h1 id="bpm-display" class="bpm-value">120</h1>
                            <p class="bpm-text">Allegro</p>
                        </div>

                        <!-- Visualization Circle -->
                        <div class="metronome-visual">
                            <div id="visual-circle" class="visual-circle"></div>
                        </div>

                        <!-- Controls -->
                        <div class="metronome-controls">
                            <button type="button" id="bpm-decrease" class="control-btn small">-</button>
                            <input type="range" id="bpm-slider" min="30" max="250" value="120" class="bpm-slider">
                            <button type="button" id="bpm-increase" class="control-btn small">+</button>
                        </div>

                        <div class="play-controls">
                            <button type="button" id="metronome-play-btn" class="play-btn">
                                <span class="btn-icon">▶</span>
                            </button>
                        </div>

                        <!-- Pendulum -->
                        <div class="pendulum-container">
                            <div class="pendulum-arm" id="pendulum-arm">
                                <div class="pendulum-weight" id="pendulum-weight"></div>
                            </div>
                            <div class="pendulum-base"></div>
                        </div>

                        <!-- Quick Settings (常時表示) -->
                        <div class="quick-settings">
                            <div class="setting-item">
                                <label>拍子</label>
                                <select id="time-signature-select" class="setting-select">
                                    <optgroup label="4分音符系">
                                        <option value="1-4">1 / 4</option>
                                        <option value="2-4">2 / 4</option>
                                        <option value="3-4">3 / 4</option>
                                        <option value="4-4" selected>4 / 4</option>
                                        <option value="5-4">5 / 4</option>
                                        <option value="6-4">6 / 4</option>
                                    </optgroup>
                                    <optgroup label="8分音符系">
                                        <option value="3-8">3 / 8</option>
                                        <option value="5-8">5 / 8</option>
                                        <option value="6-8">6 / 8</option>
                                        <option value="7-8">7 / 8</option>
                                        <option value="9-8">9 / 8</option>
                                        <option value="12-8">12 / 8</option>
                                    </optgroup>
                                    <optgroup label="その他">
                                        <option value="0">なし（アクセントなし）</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label>音符</label>
                                <select id="subdivision-select" class="setting-select">
                                    <option value="1">♩ 4分</option>
                                    <option value="2">♪ 8分</option>
                                    <option value="3">𝅗𝅥³ 3連</option>
                                    <option value="4">♬ 16分</option>
                                </select>
                            </div>
                        </div>

                        <!-- Settings Button -->
                        <button type="button" id="settings-toggle-btn" class="settings-toggle-btn">
                            <span class="settings-icon">⚙</span>
                            <span>詳細設定</span>
                        </button>

                        <!-- Settings Panel (折りたたみ) -->
                        <div id="settings-panel" class="settings-panel hidden">
                            <div class="settings-panel-header">
                                <h3>詳細設定</h3>
                                <button type="button" id="close-settings-btn" class="close-settings-btn">×</button>
                            </div>
                            <div class="settings-panel-content">
                                <div class="setting-group">
                                    <h4>サウンド</h4>
                                    <div class="setting-item">
                                        <label>音色</label>
                                        <select id="sound-type-select" class="setting-select">
                                            <option value="click">クリック</option>
                                            <option value="wood">ウッドブロック</option>
                                            <option value="beep">ビープ</option>
                                        </select>
                                    </div>
                                    <div class="setting-item">
                                        <label>音量 <span id="volume-value">80</span>%</label>
                                        <input type="range" id="volume-slider" min="0" max="100" value="80"
                                            class="volume-slider">
                                    </div>
                                </div>
                                <div class="setting-group">
                                    <h4>振り子</h4>
                                    <div class="setting-item">
                                        <label>表示</label>
                                        <select id="pendulum-select" class="setting-select">
                                            <option value="on">表示</option>
                                            <option value="off">非表示</option>
                                        </select>
                                    </div>
                                    <div class="setting-item">
                                        <label>玉の色</label>
                                        <div class="color-picker-row">
                                            <input type="color" id="pendulum-color" value="#8b5cf6"
                                                class="color-picker">
                                            <span id="pendulum-color-label" class="color-label">#8b5cf6</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="setting-group">
                                    <h4>漸進テンポ</h4>
                                    <div class="setting-item">
                                        <label>自動テンポアップ</label>
                                        <select id="tempo-progression-select" class="setting-select">
                                            <option value="off">オフ</option>
                                            <option value="on">オン</option>
                                        </select>
                                    </div>
                                    <div class="setting-item">
                                        <label>+<span id="tempo-step-value">5</span> BPM / <span
                                                id="tempo-bar-value">8</span>小節</label>
                                        <div class="dual-slider">
                                            <input type="range" id="tempo-step-slider" min="1" max="20" value="5"
                                                class="mini-slider" title="BPM増加量">
                                            <input type="range" id="tempo-bar-slider" min="1" max="32" value="8"
                                                class="mini-slider" title="小節数">
                                        </div>
                                    </div>
                                    <div class="setting-item">
                                        <label>目標BPM</label>
                                        <input type="number" id="target-tempo-input" min="30" max="300" value="180"
                                            class="setting-input">
                                    </div>
                                </div>
                                <div class="setting-group">
                                    <h4>テーマ</h4>
                                    <div class="setting-item">
                                        <label>カラーモード</label>
                                        <select id="theme-select" class="setting-select">
                                            <option value="dark">ダーク</option>
                                            <option value="light">ライト</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p class="attribution">
                練習時間計算機 |
                数理モデル: 拡張有理S-P公式
            </p>
        </footer>
    </div>

    <!-- Background Animation -->
    <div class="background-animation">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <script src="tempo-calculator.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch((err) => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>

</html>