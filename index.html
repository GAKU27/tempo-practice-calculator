<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tempo Practice Calculator | テンポ練習時間計算機</title>
    <meta name="description" content="段階的テンポ上昇トレーニングの総所要時間を高精度に算出するツール">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="tempo-calculator.css">

    <!-- iOS Web App Settings -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="練習計算機">

    <!-- Splash Screens (Sample generic definition for Safari to pick up background color) -->
    <style>
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #0f172a;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10" />
                            <polyline points="12 6 12 12 16 14" />
                        </svg>
                    </div>
                    <h1 class="logo-text">Tempo Practice Calculator</h1>
                </div>
                <p class="tagline">練習時間計算機</p>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="main-content" role="main">
            <!-- Calculator View -->
            <div id="calculator-view" class="view-section active">
                <section class="calculator-section glass-card">
                    <h2 class="section-title">
                        <span class="title-icon">⚙️</span>
                        練習パラメータ設定
                    </h2>

                    <form id="calculator-form" class="form-grid">
                        <!-- Tempo Settings -->
                        <div class="form-group-container">
                            <h3 class="group-title">テンポ設定</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="startTempo">
                                        開始テンポ
                                        <span class="unit">(BPM)</span>
                                    </label>
                                    <div class="input-wrapper">
                                        <input type="number" id="startTempo" name="startTempo" value="60" min="20"
                                            max="300" step="1" required>
                                        <span class="input-icon">🎵</span>
                                    </div>
                                    <span class="hint">a: 練習開始時の速度</span>
                                </div>

                                <div class="form-group">
                                    <label for="endTempo">
                                        目標テンポ
                                        <span class="unit">(BPM)</span>
                                    </label>
                                    <div class="input-wrapper">
                                        <input type="number" id="endTempo" name="endTempo" value="120" min="20"
                                            max="400" step="1" required>
                                        <span class="input-icon">🎯</span>
                                    </div>
                                    <span class="hint">b: 最終到達テンポ</span>
                                </div>

                            </div>
                        </div>

                        <!-- Practice Structure -->
                        <div class="form-group-container">
                            <h3 class="group-title">練習構造</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="beatsPerPhrase">
                                        拍子数
                                        <span class="unit">(拍)</span>
                                    </label>
                                    <div class="input-wrapper">
                                        <input type="number" id="beatsPerPhrase" name="beatsPerPhrase" value="4" min="1"
                                            max="64" step="1" required>
                                        <span class="input-icon">🎼</span>
                                    </div>
                                    <span class="hint">B: 1フレーズの長さ</span>
                                </div>

                                <div class="form-group">
                                    <label for="repetitions">
                                        反復回数
                                        <span class="unit">(回)</span>
                                    </label>
                                    <div class="input-wrapper">
                                        <input type="number" id="repetitions" name="repetitions" value="4" min="1"
                                            max="100" step="1" required>
                                        <span class="input-icon">🔄</span>
                                    </div>
                                    <span class="hint">R: 各テンポでの繰り返し</span>
                                </div>

                            </div>
                        </div>

                        <button type="submit" class="calculate-btn">
                            <span class="btn-icon">⏱️</span>
                            計算する
                            <span class="btn-shine"></span>
                        </button>
                    </form>
                </section>

                <!-- Results Section -->
                <section id="results-section" class="results-section glass-card hidden">
                    <h2 class="section-title">
                        <span class="title-icon">📊</span>
                        計算結果
                    </h2>

                    <!-- Summary Cards -->
                    <div class="result-cards">
                        <div class="result-card primary">
                            <div class="card-header">
                                <span class="card-icon">⏱️</span>
                                <span class="card-label">総所要時間</span>
                            </div>
                            <div class="card-value" id="totalTime">--:--</div>
                            <div class="card-sub" id="totalTimeSeconds">-- 秒</div>
                        </div>


                        <div class="result-card tertiary">
                            <div class="card-header">
                                <span class="card-icon">🎯</span>
                                <span class="card-label">実際の終了テンポ</span>
                            </div>
                            <div class="card-value" id="actualEndTempo">--</div>
                            <div class="card-sub">BPM</div>
                        </div>
                    </div>

                    <!-- Formula Display -->
                    <div class="formula-display">
                        <h3 class="formula-title">使用した数式</h3>
                        <div class="formula-box">
                            <p class="formula">T<sub>total</sub> = Σ<sub>k=a</sub><sup>b</sup> (60 × B × R) / k</p>
                            <p class="formula-description">
                                総所要時間 = 各ステップ時間の総和<br>
                                (a: 開始テンポ, b: 目標テンポ)
                            </p>
                        </div>
                    </div>

                    <!-- 練習記録への保存 -->
                    <div style="margin-top: 1.5rem; text-align: center;">
                        <button type="button" id="save-record-btn" class="calculate-btn"
                            style="background: var(--color-tertiary); margin-bottom: 2rem;">
                            <span class="btn-icon">💾</span>
                            この計算結果を練習記録に保存
                            <span class="btn-shine"></span>
                        </button>
                    </div>
                </section>

                <!-- Info Section -->
                <section class="info-section glass-card">
                    <h2 class="section-title">
                        <span class="title-icon">📖</span>
                        使い方
                    </h2>
                    <div class="info-content">
                        <div class="info-item">
                            <div class="info-number">1</div>
                            <div class="info-text">
                                <strong>テンポ設定</strong>で開始テンポ・終了テンポを選択
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-number">2</div>
                            <div class="info-text">
                                <strong>練習構造</strong>で拍子数・反復回数を設定
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-number">3</div>
                            <div class="info-text">
                                <strong>計算する</strong>ボタンで総所要時間を算出
                            </div>
                        </div>
                    </div>

                    <div class="tip-box">
                        <span class="tip-icon">💡</span>
                        <p>
                            <strong>ヒント:</strong> 低速域では時間が長くなります。
                            テンポと時間は<strong>反比例</strong>の関係（t ∝ 1/v）にあるため、
                            直感より実際は長くかかることがほとんどです。
                        </p>
                    </div>
                </section>
            </div> <!-- End Calculator View -->

            <!-- Practice Records View -->
            <div id="records-view" class="view-section hidden">
                <section class="glass-card">
                    <h2 class="section-title">
                        <span class="title-icon">📝</span>
                        練習記録
                    </h2>
                    <div id="records-list-container" class="records-container">
                        <!-- JSで動的に追加される -->
                    </div>
                </section>
            </div>

            <!-- Metronome View -->
            <div id="metronome-view" class="view-section hidden">
                <section class="metronome-section fullscreen-layout">
                    <!-- Visualization & Pendulum Area (Top) -->
                    <div class="metronome-visual-area">
                        <div class="pendulum-container">
                            <div class="pendulum-arm" id="pendulum-arm">
                                <div class="pendulum-weight" id="pendulum-weight"></div>
                            </div>
                            <div class="pendulum-base"></div>
                        </div>
                        <div id="visual-circle" class="visual-circle"></div>
                    </div>

                    <!-- Main Display & Controls (Center) -->
                    <div class="metronome-main-area">
                        <p id="tempo-text" class="bpm-text">Allegro</p>
                        <div class="bpm-controls-row">
                            <button type="button" id="bpm-decrease" class="circle-btn">-</button>
                            <h1 id="bpm-display" class="massive-bpm">120</h1>
                            <button type="button" id="bpm-increase" class="circle-btn">+</button>
                        </div>
                        <input type="range" id="bpm-slider" min="30" max="250" value="120" class="bpm-slider hidden"
                            style="display:none;">
                    </div>

                    <!-- Quick Settings Row (Bottom-Middle) -->
                    <div class="quick-settings-row">
                        <div class="compact-setting">
                            <select id="time-signature-select" class="invisible-select">
                                <option value="1-4">1/4</option>
                                <option value="2-4">2/4</option>
                                <option value="3-4">3/4</option>
                                <option value="4-4" selected>4/4</option>
                                <option value="5-4">5/4</option>
                                <option value="6-4">6/4</option>
                                <option value="3-8">3/8</option>
                                <option value="6-8">6/8</option>
                                <option value="9-8">9/8</option>
                                <option value="12-8">12/8</option>
                                <option value="0">0</option>
                            </select>
                            <span class="setting-value-display">4/4</span>
                        </div>
                        <button type="button" id="settings-toggle-btn" class="icon-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Massive Play Button (Bottom) -->
                    <div class="massive-action-area">
                        <button type="button" id="metronome-play-btn" class="massive-play-btn">START</button>
                    </div>

                    <!-- Bottom Sheet Settings (Hidden) -->
                    <div id="settings-panel" class="bottom-sheet hidden">
                        <div class="bottom-sheet-header">
                            <h3>設定</h3>
                            <button type="button" id="close-settings-btn" class="close-sheet-btn">×</button>
                        </div>
                        <div class="bottom-sheet-content">
                            <div class="setting-item">
                                <label>音符</label>
                                <select id="subdivision-select" class="setting-select">
                                    <option value="1">♩ 4分音符</option>
                                    <option value="2">♪ 8分音符</option>
                                    <option value="3">♪₃ 3連符</option>
                                    <option value="4">♬ 16分音符</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label>音色</label>
                                <select id="sound-type-select" class="setting-select">
                                    <option value="click">クリック</option>
                                    <option value="wood">ウッドブロック</option>
                                    <option value="beep">ビープ</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label>音量 <span id="volume-value">80</span>%</label>
                                <input type="range" id="volume-slider" min="0" max="100" value="80"
                                    class="volume-slider">
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Timer View -->
            <div id="timer-view" class="view-section hidden">
                <section class="timer-section fullscreen-layout">
                    <!-- Mode Selector (Top) -->
                    <div class="timer-tabs top-nav">
                        <button type="button" class="timer-tab active" data-mode="stopwatch">Stopwatch</button>
                        <button type="button" class="timer-tab" data-mode="countdown">Timer</button>
                    </div>

                    <!-- Main Display (Center) -->
                    <div class="timer-main-area">
                        <div class="massive-timer-display" id="timer-display">00:00:00</div>
                        <div class="massive-timer-ms" id="timer-ms">.00</div>

                        <!-- Countdown Settings -->
                        <div id="countdown-settings" class="countdown-settings hidden">
                            <div class="countdown-inputs">
                                <div class="countdown-input-group">
                                    <input type="number" id="countdown-minutes" value="5" min="0" max="99"
                                        class="countdown-input">
                                    <label>m</label>
                                </div>
                                <div class="countdown-input-group">
                                    <input type="number" id="countdown-seconds" value="0" min="0" max="59"
                                        class="countdown-input">
                                    <label>s</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Controls (Bottom) -->
                    <div class="timer-action-area">
                        <button type="button" id="timer-reset-btn" class="circle-btn small-circle">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polyline points="1 4 1 10 7 10"></polyline>
                                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                            </svg>
                        </button>
                        <button type="button" id="timer-start-btn" class="massive-play-btn">START</button>
                        <button type="button" id="timer-stop-btn" class="massive-play-btn stop-btn hidden">STOP</button>
                    </div>
                </section>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="view-section">
                <section class="card">
                    <h2 class="section-title">
                        <span class="title-icon">⚙️</span>
                        全体設定
                    </h2>
                    <div class="settings-content">
                        <div class="setting-group">
                            <h4>外観</h4>
                            <div class="setting-item">
                                <label>カラーモード</label>
                                <select id="theme-select" class="setting-select">
                                    <option value="dark">ダーク</option>
                                    <option value="light">ライト</option>
                                </select>
                            </div>
                        </div>

                        <div class="setting-group">
                            <h4>📱 デバイス情報</h4>
                            <div class="setting-item device-info">
                                <label>デバイスID</label>
                                <code id="device-id-display" class="device-id">読み込み中...</code>
                            </div>
                        </div>

                        <div class="setting-group danger-zone">
                            <h4>⚠️ デンジャーゾーン</h4>
                            <div class="setting-item">
                                <p class="danger-description">
                                    すべてのデータ（識別ID、練習記録、ログ）を完全に消去します。
                                    この操作は取り消せません。
                                </p>
                                <button type="button" id="delete-all-btn" class="delete-btn">
                                    <span class="delete-progress" id="delete-progress"></span>
                                    <span class="delete-text">🗑️ 全データを消去（3秒長押し）</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p class="attribution">
                練習時間計算機 |
                数理モデル: 拡張有理S-P公式
            </p>
        </footer>

        <!-- Bottom Tab Navigation -->
        <nav id="nav-menu" class="bottom-tab-bar" role="navigation" aria-label="メインナビゲーション">
            <button type="button" class="tab-item active" data-target="calculator-view" aria-label="計算機">
                <span class="tab-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="nav-svg">
                        <rect width="16" height="20" x="4" y="2" rx="2" />
                        <line x1="8" x2="16" y1="6" y2="6" />
                        <line x1="16" x2="16" y1="10" y2="10" />
                        <line x1="16" x2="16" y1="14" y2="14" />
                        <line x1="16" x2="16" y1="18" y2="18" />
                        <path d="M8 10h.01" />
                        <path d="M12 10h.01" />
                        <path d="M8 14h.01" />
                        <path d="M12 14h.01" />
                        <path d="M8 18h.01" />
                        <path d="M12 18h.01" />
                    </svg>
                </span>
                <span class="tab-label">計算</span>
            </button>
            <button type="button" class="tab-item" data-target="metronome-view" aria-label="メトロノーム">
                <span class="tab-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="nav-svg">
                        <path d="m14.5 4-5 16" />
                        <path d="m5.5 16s1.5-1 4.5-1 4 1 8 1" />
                        <path d="M12 13v-1" />
                    </svg>
                </span>
                <span class="tab-label">メトロ</span>
            </button>
            <button type="button" class="tab-item" data-target="timer-view" aria-label="タイマー">
                <span class="tab-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="nav-svg">
                        <circle cx="12" cy="12" r="10" />
                        <polyline points="12 6 12 12 16 14" />
                    </svg>
                </span>
                <span class="tab-label">タイマー</span>
            </button>
            <button type="button" class="tab-item" data-target="records-view" aria-label="練習記録">
                <span class="tab-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="nav-svg">
                        <line x1="8" x2="21" y1="6" y2="6" />
                        <line x1="8" x2="21" y1="12" y2="12" />
                        <line x1="8" x2="21" y1="18" y2="18" />
                        <line x1="3" x2="3.01" y1="6" y2="6" />
                        <line x1="3" x2="3.01" y1="12" y2="12" />
                        <line x1="3" x2="3.01" y1="18" y2="18" />
                    </svg>
                </span>
                <span class="tab-label">記録</span>
            </button>
            <button type="button" class="tab-item" data-target="settings-view" aria-label="全体設定">
                <span class="tab-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="nav-svg">
                        <path
                            d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                        <circle cx="12" cy="12" r="3" />
                    </svg>
                </span>
                <span class="tab-label">設定</span>
            </button>
        </nav>
    </div>

    <!-- Background Animation -->
    <div class="background-animation">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <script src="dist/main.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch((err) => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>

</html>