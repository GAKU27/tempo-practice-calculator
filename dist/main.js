"use strict";(()=>{var d={DEVICE_ID:"tpc_device_id",ACTION_LOG:"tpc_action_log",THEME:"tpc_theme",SETTINGS:"tpc_settings",PRACTICE_RECORDS:"tpc_practice_records"};var T=class T{constructor(){this.deviceId=this.loadOrCreate()}static getInstance(){return T.instance||(T.instance=new T),T.instance}getId(){return this.deviceId}regenerate(){return this.deviceId=this.generateUUID(),this.save(),this.deviceId}clear(){try{localStorage.removeItem(d.DEVICE_ID)}catch(e){console.warn("Failed to clear device ID:",e)}}loadOrCreate(){try{let t=localStorage.getItem(d.DEVICE_ID);if(t&&this.isValidUUID(t))return t}catch(t){console.warn("Failed to load device ID:",t)}let e=this.generateUUID();return this.deviceId=e,this.save(),e}save(){try{localStorage.setItem(d.DEVICE_ID,this.deviceId)}catch(e){console.warn("Failed to save device ID:",e)}}generateUUID(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}isValidUUID(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}getDeviceInfo(){return{deviceId:this.deviceId,userAgent:navigator.userAgent,platform:navigator.platform,language:navigator.language,createdAt:new Date().toISOString()}}};T.instance=null;var v=T;function D(){return v.getInstance().getId()}function J(){v.getInstance().clear()}var B=class{constructor(){this.audioContext=null;this.driftHistory=[];this.cumulativeDrift=0;this.lastScheduledTime=0;this.lastActualTime=0;this.MAX_DRIFT_SAMPLES=20;this.DRIFT_CORRECTION_FACTOR=.15}async initialize(){if(!this.audioContext)try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioContext.state==="suspended"&&await this.audioContext.resume();let e=this.audioContext.createBuffer(1,1,22050),t=this.audioContext.createBufferSource();t.buffer=e,t.connect(this.audioContext.destination),t.start(0)}catch(e){console.warn("Failed to initialize AudioContext:",e)}}now(){return this.audioContext&&this.audioContext.state==="running"?this.audioContext.currentTime*1e3:performance.now()}scheduleCallback(e,t){let n=this.now()+t,i=this.getCorrectedDelay(t),r=window.setTimeout(()=>{let s=this.now();this.recordTiming(n,s),e()},i);return this.lastScheduledTime=n,r}scheduleRepeating(e,t){let n=!0,i=this.now(),r=()=>{if(!n)return;let s=this.now(),o=s-i;this.recordDrift(o);let a={scheduledTime:i,actualTime:s,drift:o,cumulativeDrift:this.cumulativeDrift};e(a),i+=t;let c=Math.max(0,i-this.now()-this.getAverageDrift()*this.DRIFT_CORRECTION_FACTOR);setTimeout(r,c)};return setTimeout(r,t),()=>{n=!1}}bpmToInterval(e,t=1){return 60/e/t*1e3}getCorrectedDelay(e){let n=this.getAverageDrift()*this.DRIFT_CORRECTION_FACTOR;return Math.max(0,e-n)}recordTiming(e,t){let n=t-e;this.recordDrift(n),this.lastActualTime=t}recordDrift(e){for(this.driftHistory.push(e),this.cumulativeDrift+=e;this.driftHistory.length>this.MAX_DRIFT_SAMPLES;){let t=this.driftHistory.shift();t!==void 0&&(this.cumulativeDrift-=t)}}getAverageDrift(){return this.driftHistory.length===0?0:this.cumulativeDrift/this.driftHistory.length}getTimingStats(){return this.driftHistory.length===0?{averageDrift:0,maxDrift:0,minDrift:0,sampleCount:0}:{averageDrift:this.getAverageDrift(),maxDrift:Math.max(...this.driftHistory),minDrift:Math.min(...this.driftHistory),sampleCount:this.driftHistory.length}}reset(){this.driftHistory=[],this.cumulativeDrift=0,this.lastScheduledTime=0,this.lastActualTime=0}destroy(){this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.reset()}},_=null;function W(){return _||(_=new B),_}var b=class b{constructor(){this.MAX_ENTRIES=500;this.logs=[];this.sessionId=this.generateSessionId(),this.startTime=performance.now(),this.loadFromStorage(),window.addEventListener("beforeunload",()=>this.saveToStorage()),this.log("info","session_started",{userAgent:navigator.userAgent,viewport:{width:window.innerWidth,height:window.innerHeight}})}static getInstance(){return b.instance||(b.instance=new b),b.instance}log(e,t,n){let i={timestamp:Date.now(),action:t,details:n,latency:this.measureLatency(),level:e,deviceId:D(),sessionId:this.sessionId};for(this.logs.push(i);this.logs.length>this.MAX_ENTRIES;)this.logs.shift();(e==="error"||e==="warn")&&console[e](`[ActionLogger] ${t}`,n)}info(e,t){this.log("info",e,t)}warn(e,t){this.log("warn",e,t)}error(e,t){this.log("error",e,t)}debug(e,t){this.log("debug",e,t)}getLogs(){return[...this.logs]}getLogsByAction(e){return this.logs.filter(t=>t.action===e)}getLogsByLevel(e){return this.logs.filter(t=>t.level===e)}getCurrentSessionLogs(){return this.logs.filter(e=>e.sessionId===this.sessionId)}getStats(){let e=performance.now(),t=this.logs.filter(n=>n.latency!==void 0).map(n=>n.latency);return{totalLogs:this.logs.length,errorCount:this.logs.filter(n=>n.level==="error").length,warnCount:this.logs.filter(n=>n.level==="warn").length,avgLatency:t.length>0?t.reduce((n,i)=>n+i,0)/t.length:0,sessionDuration:e-this.startTime}}exportAsJSON(){return JSON.stringify({exportedAt:new Date().toISOString(),deviceId:D(),sessionId:this.sessionId,stats:this.getStats(),logs:this.logs},null,2)}clear(){this.logs=[],this.saveToStorage(),this.log("info","logs_cleared")}saveToStorage(){try{let e=this.logs.slice(-100);localStorage.setItem(d.ACTION_LOG,JSON.stringify(e))}catch(e){console.warn("Failed to save action logs:",e)}}loadFromStorage(){try{let e=localStorage.getItem(d.ACTION_LOG);if(e){let t=JSON.parse(e);Array.isArray(t)&&(this.logs=t)}}catch(e){console.warn("Failed to load action logs:",e),this.logs=[]}}generateSessionId(){return`${Date.now()}-${Math.random().toString(36).substring(2,9)}`}measureLatency(){return performance.now()-this.startTime}};b.instance=null;var f=b;function h(u,e){f.getInstance().info(u,e)}function j(u,e){f.getInstance().error(u,e)}function g(u,e){f.getInstance().warn(u,e)}function X(u){let e=0,t=0;for(let n=0;n<u.length;n++){let i=u[n]-t,r=e+i;t=r-e-i,e=r}return e}function F(u){let{a:e,b:t,s:n,B:i,R:r,N:s}=u;if(n<=0)throw new Error("\u30B9\u30C6\u30C3\u30D7\u5E45\u306F\u6B63\u306E\u5024\u3067\u3042\u308B\u5FC5\u8981\u304C\u3042\u308A\u307E\u3059");if(e<=0||t<=0)throw new Error("\u30C6\u30F3\u30DD\u306F\u6B63\u306E\u5024\u3067\u3042\u308B\u5FC5\u8981\u304C\u3042\u308A\u307E\u3059");if(e>=t)throw new Error("\u76EE\u6A19\u30C6\u30F3\u30DD\u306F\u958B\u59CB\u30C6\u30F3\u30DD\u3088\u308A\u5927\u304D\u304F\u8A2D\u5B9A\u3057\u3066\u304F\u3060\u3055\u3044");if(i<=0||r<=0||s<=0)throw new Error("\u62CD\u6570\u3001\u53CD\u5FA9\u56DE\u6570\u3001\u30BB\u30C3\u30C8\u6570\u306F\u6B63\u306E\u6574\u6570\u3067\u3042\u308B\u5FC5\u8981\u304C\u3042\u308A\u307E\u3059");let o=i*r,a=Math.floor((t-e)/n),c=e+a*n,l=60*o,p=[];for(let O=0;O<=a;O++){let K=e+n*O,q=l/K;p.push(q)}let m=X(p)*s,w=e+c,N=e*c,z=4*a*w/(w*w+4*N),G=w/(2*N),U=l*(z+G)*s,Y=(U-m)/m*100;return{results:{exactSeconds:m,approxSeconds:U,errorRate:Y},metadata:{nSteps:a,actualEndTempo:c,totalBeatsPerStep:o,timeConstantC:l,inputParams:{a:e,b:t,s:n,B:i,R:r,N:s}}}}function $(u){let e=Math.floor(u/3600),t=Math.floor(u%3600/60),n=Math.floor(u%60);return e>0?`${e}:${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`:`${t}:${n.toString().padStart(2,"0")}`}var C=class{constructor(){this.audioContext=null;this.isPlaying=!1;this.currentBeatInBar=0;this.currentSubdivision=0;this.beatsPerBar=4;this.subdivision=1;this.tempo=120;this.lookahead=25;this.scheduleAheadTime=.1;this.nextNoteTime=0;this.timerID=null;this.soundType="click";this.volume=.8;this.pendulumEnabled=!0;this.pendulumDirection="left";this.pendulumArm=null;this.visualCallback=null;this.pendulumCallback=null}setVisualCallback(e){this.visualCallback=e}setPendulumCallback(e){this.pendulumCallback=e}nextNote(){let t=60/this.tempo/this.subdivision;this.nextNoteTime+=t,this.currentSubdivision++,this.currentSubdivision>=this.subdivision&&(this.currentSubdivision=0,this.currentBeatInBar++,this.currentBeatInBar>=this.beatsPerBar&&(this.currentBeatInBar=0))}scheduleNote(e,t,n){let i=t===0,r=e===0&&this.beatsPerBar>0&&i;switch(this.audioContext&&requestAnimationFrame(()=>{let s=(n-this.audioContext.currentTime)*1e3;setTimeout(()=>{this.visualCallback&&this.visualCallback(e,i,r),i&&this.triggerPendulum()},Math.max(0,s))}),this.soundType){case"click":this.playClickSound(n,r,i);break;case"wood":this.playWoodSound(n,r,i);break;case"beep":this.playBeepSound(n,r,i);break;default:this.playClickSound(n,r,i)}}playClickSound(e,t,n){if(!this.audioContext)return;let i=this.audioContext.createOscillator(),r=this.audioContext.createGain();i.frequency.value=t?880:440;let s=n?1:.5;r.gain.setValueAtTime(s*this.volume,e),r.gain.exponentialRampToValueAtTime(.001,e+.02),i.connect(r),r.connect(this.audioContext.destination),i.start(e),i.stop(e+.03)}playWoodSound(e,t,n){if(!this.audioContext)return;let i=n?1:.5,r=this.audioContext.createOscillator(),s=this.audioContext.createGain();r.type="triangle",r.frequency.setValueAtTime(t?1500:1200,e),r.frequency.exponentialRampToValueAtTime(t?600:400,e+.015),s.gain.setValueAtTime((t?.6:.4)*i*this.volume,e),s.gain.exponentialRampToValueAtTime(.001,e+.04),r.connect(s),s.connect(this.audioContext.destination),r.start(e),r.stop(e+.05);let o=this.audioContext.createOscillator(),a=this.audioContext.createGain();o.type="square",o.frequency.value=t?2e3:1600,a.gain.setValueAtTime((t?.3:.2)*i*this.volume,e),a.gain.exponentialRampToValueAtTime(.001,e+.01),o.connect(a),a.connect(this.audioContext.destination),o.start(e),o.stop(e+.02)}playBeepSound(e,t,n){if(!this.audioContext)return;let i=this.audioContext.createOscillator(),r=this.audioContext.createGain();i.type="sine",i.frequency.value=t?1e3:800;let s=n?1:.5;r.gain.setValueAtTime(.5*s*this.volume,e),r.gain.exponentialRampToValueAtTime(.001,e+.08),i.connect(r),r.connect(this.audioContext.destination),i.start(e),i.stop(e+.1)}scheduler(){if(this.audioContext){for(;this.nextNoteTime<this.audioContext.currentTime+this.scheduleAheadTime;)this.scheduleNote(this.currentBeatInBar,this.currentSubdivision,this.nextNoteTime),this.nextNote();this.timerID=window.setTimeout(()=>this.scheduler(),this.lookahead)}}start(){if(this.isPlaying)return;if(!this.audioContext){let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n}let e=()=>this.audioContext&&this.audioContext.state==="suspended"?this.audioContext.resume():Promise.resolve(),t=()=>{if(!this.audioContext)return;let n=this.audioContext.createBuffer(1,1,22050),i=this.audioContext.createBufferSource();i.buffer=n,i.connect(this.audioContext.destination),i.start(0)};e().then(()=>{t(),this._startPlayback()}).catch(n=>{console.log("Audio unlock failed:",n),this._startPlayback()})}_startPlayback(){this.audioContext&&(this.isPlaying=!0,this.currentBeatInBar=0,this.currentSubdivision=0,this.nextNoteTime=this.audioContext.currentTime+.1,this.scheduler())}stop(){this.isPlaying=!1,this.timerID!==null&&(clearTimeout(this.timerID),this.timerID=null)}setTempo(e){this.tempo=e}setBeatsPerBar(e){this.beatsPerBar=e}setSoundType(e){this.soundType=e}setVolume(e){this.volume=e}setSubdivision(e){this.subdivision=e}setPendulumEnabled(e){this.pendulumEnabled=e}triggerPendulum(){this.pendulumEnabled&&(this.pendulumDirection==="left"?this.pendulumDirection="right":this.pendulumDirection="left",this.pendulumCallback&&this.pendulumCallback(this.pendulumDirection))}};var y=class y{constructor(){this.initialized=!1;this.touchStartY=0}static getInstance(){return y.instance||(y.instance=new y),y.instance}init(){this.initialized||(this.preventPinchZoom(),this.preventGestures(),this.preventOverscroll(),this.preventDoubleTapZoom(),this.initialized=!0,h("touch_controller_initialized"))}preventPinchZoom(){document.addEventListener("touchstart",e=>{e.touches.length>1&&(e.preventDefault(),g("pinch_attempt_blocked",{touchCount:e.touches.length}))},{passive:!1}),document.addEventListener("touchmove",e=>{e.touches.length>1&&e.preventDefault()},{passive:!1}),document.addEventListener("wheel",e=>{e.ctrlKey&&(e.preventDefault(),g("ctrl_wheel_zoom_blocked"))},{passive:!1})}preventGestures(){document.addEventListener("gesturestart",e=>{e.preventDefault()}),document.addEventListener("gesturechange",e=>{e.preventDefault()}),document.addEventListener("gestureend",e=>{e.preventDefault()})}preventOverscroll(){document.body.style.overscrollBehavior="none",document.documentElement.style.overscrollBehavior="none";let e=document.getElementById("nav-menu"),t=document.getElementById("nav-overlay");e&&(e.style.overscrollBehavior="contain",e.addEventListener("touchstart",n=>{this.touchStartY=n.touches[0].clientY},{passive:!0}),e.addEventListener("touchmove",n=>{let i=e.querySelector(".nav-list");if(!i){n.preventDefault();return}let s=n.touches[0].clientY-this.touchStartY,o=i.scrollTop<=0,a=i.scrollTop+i.clientHeight>=i.scrollHeight;(o&&s>0||a&&s<0)&&n.preventDefault()},{passive:!1})),t&&(t.style.overscrollBehavior="none",t.addEventListener("touchmove",n=>{n.preventDefault()},{passive:!1}))}preventDoubleTapZoom(){let e=0;document.addEventListener("touchend",t=>{let n=Date.now();n-e<=300&&(t.preventDefault(),g("double_tap_zoom_blocked")),e=n},{passive:!1})}enableScrollingFor(e){e.style.touchAction="pan-y",e.style.overscrollBehavior="contain"}enableAllTouchFor(e){e.style.touchAction="auto"}resetViewport(){if(window.visualViewport){let e=window.visualViewport;e.scale!==1&&(g("viewport_scale_reset",{previousScale:e.scale,previousOffsetLeft:e.offsetLeft,previousOffsetTop:e.offsetTop}),window.scrollTo(0,0))}}watchViewport(e){if(!window.visualViewport)return()=>{};let t=()=>{e(window.visualViewport.scale)};return window.visualViewport.addEventListener("resize",t),()=>{window.visualViewport.removeEventListener("resize",t)}}};y.instance=null;var M=y;function Z(){M.getInstance().init()}var E=class E{constructor(){this.currentMode="dark";this.DEFAULT_DARK_THEME={backgroundColor:"#0f0f1a",borderColor:"#2a2a4a",textColor:"#ffffff",accentColor:"#8b5cf6"};this.DEFAULT_LIGHT_THEME={backgroundColor:"#f5f5f7",borderColor:"#d1d1d6",textColor:"#1d1d1f",accentColor:"#7c3aed"};this.currentTheme=this.DEFAULT_DARK_THEME,this.loadFromStorage()}static getInstance(){return E.instance||(E.instance=new E),E.instance}getLuminance(e){let t=this.hexToRgb(e),n=this.linearize(t.r/255),i=this.linearize(t.g/255),r=this.linearize(t.b/255);return .2126*n+.7152*i+.0722*r}getBrightness(e){let t=this.hexToRgb(e);return .299*t.r+.587*t.g+.114*t.b}getContrastRatio(e,t){let n=this.getLuminance(e),i=this.getLuminance(t),r=Math.max(n,i),s=Math.min(n,i);return(r+.05)/(s+.05)}calculateBorderColor(e){let t=this.getBrightness(e),n=this.hexToRgb(e);return t>128?this.rgbToHex({r:Math.max(0,Math.round(n.r*.85)),g:Math.max(0,Math.round(n.g*.85)),b:Math.max(0,Math.round(n.b*.85))}):this.rgbToHex({r:Math.min(255,Math.round(n.r+(255-n.r)*.15)),g:Math.min(255,Math.round(n.g+(255-n.g)*.15)),b:Math.min(255,Math.round(n.b+(255-n.b)*.15))})}calculateTextColor(e){let t=this.getBrightness(e),n=t>128?"#000000":"#ffffff";return this.getContrastRatio(e,n)>=4.5?n:t>128?"#1a1a1a":"#f0f0f0"}calculateAccentColor(e,t){let n=this.getBrightness(e),i=this.hexToRgb(t),r=this.rgbToHsl(i);return n>128?r.l=Math.max(25,r.l-15):r.l=Math.min(75,r.l+10),this.hslToHex(r)}setMode(e){this.currentMode=e,this.currentTheme=e==="dark"?{...this.DEFAULT_DARK_THEME}:{...this.DEFAULT_LIGHT_THEME},this.applyTheme(),this.saveToStorage(),h("theme_mode_changed",{mode:e})}initUI(){let e=document.getElementById("theme-select");e&&(e.value=this.currentMode,e.addEventListener("change",t=>{this.setMode(t.target.value)}))}setBackgroundColor(e){this.currentTheme={backgroundColor:e,borderColor:this.calculateBorderColor(e),textColor:this.calculateTextColor(e),accentColor:this.calculateAccentColor(e,this.currentTheme.accentColor)},this.applyTheme(),this.saveToStorage(),h("background_color_changed",{bgColor:e,theme:this.currentTheme})}applyTheme(){let e=document.documentElement;e.style.setProperty("--bg-color",this.currentTheme.backgroundColor),e.style.setProperty("--border-color",this.currentTheme.borderColor),e.style.setProperty("--text-color",this.currentTheme.textColor),e.style.setProperty("--accent-color",this.currentTheme.accentColor),e.setAttribute("data-theme",this.currentMode)}getTheme(){return{...this.currentTheme}}getMode(){return this.currentMode}saveToStorage(){try{let e={theme:this.currentTheme,mode:this.currentMode};localStorage.setItem(d.THEME,JSON.stringify(e))}catch(e){console.warn("Failed to save theme:",e)}}loadFromStorage(){try{let e=localStorage.getItem(d.THEME);if(e){let t=JSON.parse(e);t.theme&&(this.currentTheme=t.theme),t.mode&&(this.currentMode=t.mode),this.applyTheme()}}catch(e){console.warn("Failed to load theme:",e)}}hexToRgb(e){let t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:0,g:0,b:0}}rgbToHex(e){return"#"+[e.r,e.g,e.b].map(t=>Math.round(Math.max(0,Math.min(255,t))).toString(16).padStart(2,"0")).join("")}rgbToHsl(e){let t=e.r/255,n=e.g/255,i=e.b/255,r=Math.max(t,n,i),s=Math.min(t,n,i),o=0,a=0,c=(r+s)/2;if(r!==s){let l=r-s;switch(a=c>.5?l/(2-r-s):l/(r+s),r){case t:o=((n-i)/l+(n<i?6:0))/6;break;case n:o=((i-t)/l+2)/6;break;case i:o=((t-n)/l+4)/6;break}}return{h:o*360,s:a*100,l:c*100}}hslToHex(e){let t=e.h/360,n=e.s/100,i=e.l/100,r,s,o;if(n===0)r=s=o=i;else{let a=(p,S,m)=>(m<0&&(m+=1),m>1&&(m-=1),m<.16666666666666666?p+(S-p)*6*m:m<.5?S:m<.6666666666666666?p+(S-p)*(.6666666666666666-m)*6:p),c=i<.5?i*(1+n):i+n-i*n,l=2*i-c;r=a(l,c,t+1/3),s=a(l,c,t),o=a(l,c,t-1/3)}return this.rgbToHex({r:Math.round(r*255),g:Math.round(s*255),b:Math.round(o*255)})}linearize(e){return e<=.03928?e/12.92:Math.pow((e+.055)/1.055,2.4)}};E.instance=null;var x=E;function Q(u){x.getInstance().setMode(u)}function ee(u){x.getInstance().setBackgroundColor(u)}var L=class L{constructor(){this.HOLD_DURATION=3e3;this.holdStartTime=null;this.progressTimer=null;this.animationFrame=null;this.onProgressChange=null;this.onDeleteComplete=null}static getInstance(){return L.instance||(L.instance=new L),L.instance}initDeleteButton(e,t,n){let i=document.getElementById(e),r=document.getElementById(t);if(!i){g("delete_button_not_found",{buttonId:e});return}this.onProgressChange=n?.onProgress||null,this.onDeleteComplete=n?.onComplete||null,i.addEventListener("touchstart",s=>{s.preventDefault(),this.startHold(r)},{passive:!1}),i.addEventListener("touchend",()=>this.cancelHold(r)),i.addEventListener("touchcancel",()=>this.cancelHold(r)),i.addEventListener("mousedown",()=>this.startHold(r)),i.addEventListener("mouseup",()=>this.cancelHold(r)),i.addEventListener("mouseleave",()=>this.cancelHold(r)),h("delete_button_initialized",{buttonId:e,progressId:t})}startHold(e){this.holdStartTime=Date.now(),h("delete_hold_started"),e&&(e.style.transition="none",e.style.width="0%",e.offsetWidth,e.style.transition=`width ${this.HOLD_DURATION}ms linear`,e.style.width="100%");let t=()=>{if(this.holdStartTime===null)return;let n=Date.now()-this.holdStartTime,i=Math.min(n/this.HOLD_DURATION*100,100);this.onProgressChange&&this.onProgressChange(i),i<100&&(this.animationFrame=requestAnimationFrame(t))};this.animationFrame=requestAnimationFrame(t),this.progressTimer=window.setTimeout(()=>{this.executeDelete()},this.HOLD_DURATION)}cancelHold(e){if(this.holdStartTime===null)return;let t=Date.now()-this.holdStartTime;h("delete_hold_cancelled",{elapsed:t,percentage:t/this.HOLD_DURATION*100}),this.progressTimer&&(clearTimeout(this.progressTimer),this.progressTimer=null),this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=null),e&&(e.style.transition="width 0.2s ease",e.style.width="0%"),this.onProgressChange&&this.onProgressChange(0),this.holdStartTime=null}executeDelete(){h("delete_executed"),Object.values(d).forEach(t=>{try{localStorage.removeItem(t)}catch(n){console.warn(`Failed to remove ${t}:`,n)}}),v.getInstance().regenerate(),this.onDeleteComplete&&this.onDeleteComplete(),window.location.reload()}deleteSpecific(e){e.forEach(t=>{let n=d[t];try{localStorage.removeItem(n),h("specific_data_deleted",{key:n})}catch(i){g("delete_failed",{key:n,error:String(i)})}})}getStorageUsage(){let e=[],t=0;return Object.values(d).forEach(n=>{try{let i=localStorage.getItem(n);if(i){let r=new Blob([i]).size;e.push({key:n,size:r}),t+=r}}catch{}}),{used:t,available:5*1024*1024-t,items:e}}exportAllData(){let e={};return Object.entries(d).forEach(([t,n])=>{try{let i=localStorage.getItem(n);if(i)try{e[t]=JSON.parse(i)}catch{e[t]=i}}catch{}}),JSON.stringify({exportedAt:new Date().toISOString(),deviceId:v.getInstance().getId(),data:e},null,2)}importData(e){try{let t=JSON.parse(e);return t.data?(Object.entries(t.data).forEach(([n,i])=>{let r=d[n];r&&localStorage.setItem(r,JSON.stringify(i))}),h("data_imported",{itemCount:Object.keys(t.data).length}),!0):(g("import_failed",{reason:"No data field"}),!1)}catch(t){return g("import_failed",{error:String(t)}),!1}}};L.instance=null;var I=L;function te(u,e){I.getInstance().initDeleteButton(u,e)}function ne(){return I.getInstance().exportAllData()}var H=class{constructor(){this.form=null;this.resultsSection=null;this.totalTimeDisplay=null;this.totalTimeSecondsDisplay=null;this.actualEndTempoDisplay=null;this.exactTimeDisplay=null;this.approxTimeDisplay=null;this.errorRateDisplay=null;this.totalBeatsPerStepDisplay=null}init(){this.form=document.getElementById("calculator-form"),this.resultsSection=document.getElementById("results-section"),this.totalTimeDisplay=document.getElementById("totalTime"),this.totalTimeSecondsDisplay=document.getElementById("totalTimeSeconds"),this.actualEndTempoDisplay=document.getElementById("actualEndTempo"),this.exactTimeDisplay=document.getElementById("exactTime"),this.approxTimeDisplay=document.getElementById("approxTime"),this.errorRateDisplay=document.getElementById("errorRate"),this.totalBeatsPerStepDisplay=document.getElementById("totalBeatsPerStep"),this.form&&(this.form.addEventListener("submit",this.handleSubmit.bind(this)),this.setupValidation()),this.setupKeyboardShortcuts()}handleSubmit(e){if(e.preventDefault(),!this.form)return;let t=new FormData(this.form),n={a:parseFloat(t.get("startTempo")),b:parseFloat(t.get("endTempo")),s:1,B:parseInt(t.get("beatsPerPhrase"),10),R:parseInt(t.get("repetitions"),10),N:1};try{let i=F(n);this.displayResults(i),console.log("\u8A08\u7B97\u7D50\u679C:",i)}catch(i){this.showError(i.message||"\u8A08\u7B97\u30A8\u30E9\u30FC"),console.error("\u8A08\u7B97\u30A8\u30E9\u30FC:",i)}}setupValidation(){if(!this.form)return;this.form.querySelectorAll('input[type="number"]').forEach(t=>{t.addEventListener("input",function(){let n=parseFloat(this.min),i=parseFloat(this.max),r=parseFloat(this.value);r<n||r>i?this.style.borderColor="rgba(239, 68, 68, 0.5)":this.style.borderColor=""}),t.addEventListener("focus",function(){this.select()})})}setupKeyboardShortcuts(){document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&e.key==="Enter"&&(e.preventDefault(),this.form&&this.form.dispatchEvent(new Event("submit")))})}displayResults(e){if(!this.resultsSection)return;let{exactSeconds:t,approxSeconds:n,errorRate:i}=e.results,{actualEndTempo:r,totalBeatsPerStep:s}=e.metadata;if(this.animateNumber(this.totalTimeDisplay,null,$(t)),this.animateNumber(this.totalTimeSecondsDisplay,t,null," \u79D2"),this.actualEndTempoDisplay&&(this.actualEndTempoDisplay.textContent=`${r} BPM`),this.exactTimeDisplay&&(this.exactTimeDisplay.textContent=`${t.toFixed(3)} \u79D2`),this.approxTimeDisplay&&(this.approxTimeDisplay.textContent=`${n.toFixed(3)} \u79D2`),this.errorRateDisplay){let c=i<0?"":"+";this.errorRateDisplay.textContent=`${c}${i.toExponential(2)} %`,this.errorRateDisplay.style.color=Math.abs(i)<.01?"var(--color-tertiary)":"var(--color-text-secondary)"}this.totalBeatsPerStepDisplay&&(this.totalBeatsPerStepDisplay.textContent=`${s} \u62CD`),this.resultsSection.classList.remove("hidden");let o=document.querySelector(".result-card.primary");o&&(o.style.transform="scale(1.02)",o.style.boxShadow="0 0 30px rgba(99, 102, 241, 0.3)",setTimeout(()=>{o.style.transform="",o.style.boxShadow=""},300))}showError(e){this.resultsSection&&(this.resultsSection.classList.remove("hidden"),this.resultsSection.innerHTML=`
            <div class="error-message" style="
                background: rgba(239, 68, 68, 0.1);
                border: 1px solid rgba(239, 68, 68, 0.3);
                color: #fca5a5;
                padding: var(--space-lg);
                border-radius: var(--radius-md);
                text-align: center;
            ">
                <span style="font-size: var(--font-size-xl); display: block; margin-bottom: var(--space-sm);">\u26A0\uFE0F</span>
                ${e}
            </div>
        `,setTimeout(()=>{window.location.reload()},3e3))}animateNumber(e,t,n=null,i=""){e&&(e.style.opacity="0",e.style.transform="translateY(-10px)",setTimeout(()=>{if(n!==null)e.textContent=n;else if(t!==null){let r=0,s=500,o=20,a=t/o,c=s/o,l=0,p=setInterval(()=>{l++,r+=a,l>=o?(e.textContent=t.toFixed(1)+i,clearInterval(p)):e.textContent=r.toFixed(1)+i},c)}e.style.transition="all 0.4s ease",e.style.opacity="1",e.style.transform="translateY(0)"},50))}};var A=class{constructor(){this.bpmDisplay=null;this.bpmSlider=null;this.playBtn=null;this.visualCircle=null;this.metronome=new C}init(){this.bpmDisplay=document.getElementById("bpm-display"),this.bpmSlider=document.getElementById("bpm-slider");let e=document.getElementById("bpm-increase"),t=document.getElementById("bpm-decrease");this.playBtn=document.getElementById("metronome-play-btn");let n=document.getElementById("tap-tempo-btn"),i=document.getElementById("time-signature-select"),r=document.getElementById("subdivision-select"),s=document.getElementById("sound-select"),o=document.getElementById("volume-slider"),a=document.getElementById("pendulum-toggle");this.visualCircle=document.getElementById("visual-circle");let c=document.getElementById("pendulum-arm");if(!this.bpmDisplay||!this.bpmSlider||!this.playBtn){console.error("Metronome elements not found");return}this.metronome.setVisualCallback((l,p,S)=>{this.visualCircle&&(this.visualCircle.className="visual-circle",this.visualCircle.offsetWidth,S?this.visualCircle.classList.add("accent"):p?this.visualCircle.classList.add("beat"):this.visualCircle.classList.add("sub-beat"),setTimeout(()=>{this.visualCircle&&this.visualCircle.classList.remove("beat","accent","sub-beat")},100))}),this.metronome.setPendulumCallback(l=>{c&&(c.classList.remove("swinging-left","swinging-right"),c.offsetWidth,l==="right"?c.classList.add("swinging-right"):c.classList.add("swinging-left"))}),this.updateTempo(120),i&&(this.metronome.setBeatsPerBar(parseInt(i.value,10)),i.addEventListener("change",l=>{this.metronome.setBeatsPerBar(parseInt(l.target.value,10))})),r&&(this.metronome.setSubdivision(parseInt(r.value,10)),r.addEventListener("change",l=>{this.metronome.setSubdivision(parseInt(l.target.value,10))})),s&&(this.metronome.setSoundType(s.value),s.addEventListener("change",l=>{this.metronome.setSoundType(l.target.value)})),o&&(this.metronome.setVolume(parseFloat(o.value)),o.addEventListener("input",l=>{this.metronome.setVolume(parseFloat(l.target.value))})),a&&(this.metronome.setPendulumEnabled(a.checked),a.addEventListener("change",l=>{this.metronome.setPendulumEnabled(l.target.checked)})),this.bpmSlider.addEventListener("input",l=>{this.updateTempo(parseInt(l.target.value,10))}),t&&t.addEventListener("click",()=>{this.bpmSlider&&this.updateTempo(parseInt(this.bpmSlider.value,10)-1)}),e&&e.addEventListener("click",()=>{this.bpmSlider&&this.updateTempo(parseInt(this.bpmSlider.value,10)+1)}),this.playBtn.addEventListener("click",()=>{this.metronome.isPlaying?(this.metronome.stop(),this.playBtn?.classList.remove("playing"),c&&c.classList.remove("swinging-left","swinging-right")):(this.metronome.start(),this.playBtn?.classList.add("playing"))}),n&&this.setupTapTempo(n),this.setupSettingsModal()}updateTempo(e){let t=Math.min(Math.max(e,30),250);this.bpmDisplay&&(this.bpmDisplay.textContent=t.toString()),this.bpmSlider&&(this.bpmSlider.value=t.toString()),this.metronome.setTempo(t);let n=document.getElementById("tempo-text");n&&(n.textContent=this.getTempoText(t))}getTempoText(e){return e<40?"Grave (\u975E\u5E38\u306B\u9045\u304F)":e<50?"Largo (\u5E45\u5E83\u304F\u3001\u9045\u304F)":e<60?"Lento (\u9045\u304F)":e<66?"Larghetto (Largo\u3088\u308A\u3084\u3084\u901F\u304F)":e<76?"Adagio (\u3086\u308B\u3084\u304B\u306B)":e<108?"Andante (\u6B69\u304F\u3088\u3046\u306A\u901F\u3055\u3067)":e<120?"Moderato (\u4E2D\u304F\u3089\u3044\u306E\u901F\u3055\u3067)":e<156?"Allegro (\u5FEB\u6D3B\u306B\u901F\u304F)":e<176?"Vivace (\u751F\u304D\u751F\u304D\u3068\u901F\u304F)":e<200?"Presto (\u6025\u901F\u306B)":"Prestissimo (\u6975\u3081\u3066\u6025\u901F\u306B)"}setupTapTempo(e){let t=[];e.addEventListener("click",()=>{let i=Date.now();if(t.length>0&&i-t[t.length-1]>2e3&&(t=[]),t.push(i),t.length>4&&t.shift(),t.length>=2){let s=[];for(let c=1;c<t.length;c++)s.push(t[c]-t[c-1]);let o=s.reduce((c,l)=>c+l)/s.length,a=Math.round(6e4/o);a>=30&&a<=250&&this.updateTempo(a)}let r=e.innerHTML;e.innerHTML="\u{1F463} Tapped!",e.style.color="var(--color-primary-light)",e.style.borderColor="var(--color-primary)",setTimeout(()=>{e.innerHTML=r,e.style.color="",e.style.borderColor=""},300)})}setupSettingsModal(){let e=document.getElementById("settings-toggle-btn"),t=document.getElementById("settings-panel"),n=document.getElementById("close-settings-btn"),i=document.getElementById("pendulum-toggle"),r=document.getElementById("pendulum-container");if(e&&t&&n){let s=()=>{t.classList.toggle("hidden")};e.addEventListener("click",s),n.addEventListener("click",s)}i&&r&&i.addEventListener("change",s=>{s.target.checked?r.classList.remove("hidden"):r.classList.add("hidden")})}stop(){this.metronome.isPlaying&&(this.metronome.stop(),this.playBtn?.classList.remove("playing"))}};var P=class{constructor(){this.timerInterval=null;this.elapsedTime=0;this.isRunning=!1;this.isCountdown=!1;this.countdownTarget=0;this.laps=[];this.lastLapTime=0;this.timerDisplay=null;this.timerMs=null;this.startBtn=null;this.stopBtn=null;this.resetBtn=null;this.lapBtn=null;this.lapList=null;this.countdownSettings=null;this.countdownMinutes=null;this.countdownSeconds=null}init(){this.timerDisplay=document.getElementById("timer-display"),this.timerMs=document.getElementById("timer-ms"),this.startBtn=document.getElementById("timer-start-btn"),this.stopBtn=document.getElementById("timer-stop-btn"),this.resetBtn=document.getElementById("timer-reset-btn"),this.lapBtn=document.getElementById("lap-btn"),this.lapList=document.getElementById("lap-list");let e=document.querySelectorAll(".timer-tab");this.countdownSettings=document.getElementById("countdown-settings"),this.countdownMinutes=document.getElementById("countdown-minutes"),this.countdownSeconds=document.getElementById("countdown-seconds"),!(!this.timerDisplay||!this.startBtn)&&(this.startBtn.addEventListener("click",this.startTimer.bind(this)),this.stopBtn&&this.stopBtn.addEventListener("click",this.stopTimer.bind(this)),this.resetBtn&&this.resetBtn.addEventListener("click",this.resetTimer.bind(this)),this.lapBtn&&this.lapBtn.addEventListener("click",this.recordLap.bind(this)),e.forEach(t=>{t.addEventListener("click",()=>{e.forEach(n=>n.classList.remove("active")),t.classList.add("active"),this.isCountdown=t.dataset.mode==="countdown",this.countdownSettings&&this.countdownSettings.classList.toggle("hidden",!this.isCountdown),this.resetTimer()})}),this.updateDisplay())}formatTime(e){let t=Math.floor(e/1e3),n=Math.floor(t/3600),i=Math.floor(t%3600/60),r=t%60;return`${String(n).padStart(2,"0")}:${String(i).padStart(2,"0")}:${String(r).padStart(2,"0")}`}formatMs(e){return`.${String(Math.floor(e%1e3/10)).padStart(2,"0")}`}updateDisplay(){let e=this.isCountdown?Math.max(0,this.countdownTarget-this.elapsedTime):this.elapsedTime;this.timerDisplay&&(this.timerDisplay.textContent=this.formatTime(e)),this.timerMs&&(this.timerMs.textContent=this.formatMs(e)),this.isCountdown&&e<=0&&this.isRunning&&(this.stopTimer(),this.timerDisplay&&(this.timerDisplay.style.color="#ef4444"),this.playTimerBeep())}playTimerBeep(){try{let e=window.AudioContext||window.webkitAudioContext,t=new e,n=t.createOscillator(),i=t.createGain();n.type="sine",n.frequency.value=880,i.gain.value=.3,n.connect(i),i.connect(t.destination),n.start(),n.stop(t.currentTime+.5)}catch{console.log("Audio not available")}}startTimer(){if(this.isRunning)return;if(this.isCountdown){let t=this.countdownMinutes&&parseInt(this.countdownMinutes.value)||0,n=this.countdownSeconds&&parseInt(this.countdownSeconds.value)||0;if(this.countdownTarget=(t*60+n)*1e3,this.countdownTarget<=0)return}this.isRunning=!0;let e=Date.now()-this.elapsedTime;this.timerInterval=window.setInterval(()=>{this.elapsedTime=Date.now()-e,this.updateDisplay()},10),this.startBtn&&(this.startBtn.disabled=!0),this.stopBtn&&(this.stopBtn.disabled=!1),this.lapBtn&&(this.lapBtn.disabled=!1),this.timerDisplay&&(this.timerDisplay.style.color="")}stopTimer(){this.isRunning&&(this.isRunning=!1,this.timerInterval!==null&&(clearInterval(this.timerInterval),this.timerInterval=null),this.startBtn&&(this.startBtn.disabled=!1),this.stopBtn&&(this.stopBtn.disabled=!0))}resetTimer(){this.stopTimer(),this.elapsedTime=0,this.laps=[],this.lastLapTime=0,this.updateDisplay(),this.lapList&&(this.lapList.innerHTML=""),this.lapBtn&&(this.lapBtn.disabled=!0),this.timerDisplay&&(this.timerDisplay.style.color="")}recordLap(){if(!this.isRunning)return;let e=this.elapsedTime,t=e-this.lastLapTime;if(this.lastLapTime=e,this.laps.push({time:e,diff:t}),this.lapList){let n=document.createElement("li");n.className="lap-item",n.innerHTML=`
                <span class="lap-number">#${this.laps.length}</span>
                <span class="lap-time">${this.formatTime(e)}${this.formatMs(e)}</span>
                <span class="lap-diff">+${this.formatTime(t)}${this.formatMs(t)}</span>
            `,this.lapList.insertBefore(n,this.lapList.firstChild)}}};var R=class{constructor(){this.STORAGE_KEY="tpc_practice_records";this.records=[];this.saveBtn=null;this.clearBtn=null;this.recordsList=null}init(){this.saveBtn=document.getElementById("save-record-btn"),this.clearBtn=document.getElementById("clear-records-btn"),this.recordsList=document.getElementById("records-list"),this.loadRecords(),this.renderRecords(),this.saveBtn&&this.saveBtn.addEventListener("click",this.handleSave.bind(this)),this.clearBtn&&this.clearBtn.addEventListener("click",this.handleClear.bind(this))}loadRecords(){try{let e=localStorage.getItem(this.STORAGE_KEY);e&&(this.records=JSON.parse(e))}catch(e){console.error("Failed to load practice records",e)}}saveAndRender(){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.records)),this.renderRecords()}catch(e){console.error("Failed to save practice records",e)}}renderRecords(){if(this.recordsList){if(this.records.length===0){this.recordsList.innerHTML=`
                <div class="empty-state" style="text-align: center; padding: var(--space-xl); color: var(--color-text-muted);">
                    <div style="font-size: 3rem; margin-bottom: var(--space-sm); opacity: 0.5;">\u{1F4DD}</div>
                    <p>\u8A18\u9332\u304C\u3042\u308A\u307E\u305B\u3093</p>
                    <p style="font-size: var(--font-size-xs);">\u8A08\u7B97\u7D50\u679C\u753B\u9762\u304B\u3089\u300C\u7DF4\u7FD2\u8A18\u9332\u306B\u4FDD\u5B58\u300D\u3092\u30AF\u30EA\u30C3\u30AF\u3059\u308B\u3068\u8868\u793A\u3055\u308C\u307E\u3059</p>
                </div>`;return}this.recordsList.innerHTML=this.records.map((e,t)=>{let n=new Date(e.timestamp);return`
                <div class="record-item" style="background: rgba(15, 23, 42, 0.4); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-md); margin-bottom: var(--space-md); display: flex; justify-content: space-between; align-items: center;">
                    <div class="record-info">
                        <div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: var(--space-xs);">${`${n.getFullYear()}/${(n.getMonth()+1).toString().padStart(2,"0")}/${n.getDate().toString().padStart(2,"0")} ${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}`}</div>
                        <div style="font-size: var(--font-size-base); font-weight: 500; color: var(--color-text-primary);">
                            \u{1F3B5} ${e.startTempo} BPM \u2192 \u{1F3AF} ${e.endTempo} BPM
                        </div>
                        <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--space-xs);">
                            \u23F1\uFE0F \u6642\u9593: ${e.formattedTime} | \u{1F3BC} ${e.beatsPerPhrase}\u62CD \xD7 ${e.repetitions}\u56DE
                        </div>
                    </div>
                    <button type="button" class="control-btn small delete-record-btn" data-index="${t}" style="color: #ef4444; border-color: rgba(239, 68, 68, 0.3);">
                        \u{1F5D1}\uFE0F
                    </button>
                </div>
            `}).join(""),this.recordsList.querySelectorAll(".delete-record-btn").forEach(e=>{e.addEventListener("click",t=>{let n=t.currentTarget,i=parseInt(n.getAttribute("data-index")||"0",10);this.records.splice(i,1),this.saveAndRender()})})}}handleSave(){let e=document.getElementById("totalTime");if(!e||e.textContent==="--:--"){this.showFeedbackError("\u8A08\u7B97\u7D50\u679C\u304C\u3042\u308A\u307E\u305B\u3093");return}let t=document.getElementById("calculator-form"),n=new FormData(t),i={timestamp:Date.now(),startTempo:n.get("startTempo"),endTempo:n.get("endTempo"),beatsPerPhrase:n.get("beatsPerPhrase"),repetitions:n.get("repetitions"),formattedTime:e.textContent||""};if(this.records.unshift(i),this.saveAndRender(),this.saveBtn){let r=this.saveBtn.innerHTML;this.saveBtn.innerHTML='<span class="btn-icon">\u2705</span> \u4FDD\u5B58\u3057\u307E\u3057\u305F',this.saveBtn.style.background="var(--color-tertiary)",setTimeout(()=>{this.saveBtn&&(this.saveBtn.innerHTML=r,this.saveBtn.style.background="var(--gradient-primary)")},2e3)}}handleClear(){this.records.length!==0&&confirm("\u3059\u3079\u3066\u306E\u7DF4\u7FD2\u8A18\u9332\u3092\u6D88\u53BB\u3057\u307E\u3059\u304B\uFF1F")&&(this.records=[],this.saveAndRender())}showFeedbackError(e){alert(e)}};var k=class{constructor(){this.menuBtn=null;this.closeMenuBtn=null;this.navMenu=null;this.navOverlay=null;this.navItems=null;this.viewSections=null;this.metronomeUI=null}setMetronomeUI(e){this.metronomeUI=e}init(){if(this.menuBtn=document.getElementById("menu-btn"),this.closeMenuBtn=document.getElementById("close-menu-btn"),this.navMenu=document.getElementById("nav-menu"),this.navOverlay=document.getElementById("nav-overlay"),this.navItems=document.querySelectorAll(".nav-item"),this.viewSections=document.querySelectorAll(".view-section"),!this.menuBtn||!this.navMenu||!this.navOverlay){console.error("Navigation elements not found. Check HTML IDs.");return}let e=()=>{this.navMenu&&this.navMenu.classList.toggle("active"),this.navOverlay&&this.navOverlay.classList.toggle("active")};this.menuBtn.addEventListener("click",t=>{t.stopPropagation(),e()}),this.closeMenuBtn&&this.closeMenuBtn.addEventListener("click",e),this.navOverlay.addEventListener("click",e),this.navItems&&this.navItems.forEach(t=>{t.addEventListener("click",()=>{let n=t.getAttribute("data-target");this.viewSections&&this.viewSections.forEach(i=>{i.id===n?(i.classList.remove("hidden"),i.classList.add("active")):(i.classList.add("hidden"),i.classList.remove("active"))}),this.navItems&&this.navItems.forEach(i=>i.classList.remove("active")),t.classList.add("active"),e(),n!=="metronome-view"&&this.metronomeUI&&this.metronomeUI.stop()})})}};function V(){let u=v.getInstance().getId();console.log(`[TPC] Device ID: ${u}`),f.getInstance().info("app_initialized",{deviceId:u,timestamp:Date.now(),url:window.location.href}),M.getInstance().init();let e=x.getInstance();e.applyTheme(),e.initUI();let t=document.getElementById("delete-all-btn"),n=document.getElementById("delete-progress");t&&n&&I.getInstance().initDeleteButton("delete-all-btn","delete-progress"),new H().init();let r=new A;r.init(),new P().init(),new R().init();let a=new k;a.init(),a.setMetronomeUI(r),console.log("[TPC] Tempo Practice Calculator initialized (TypeScript Edition Phase 6)")}typeof document<"u"&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",V):V());})();
//# sourceMappingURL=main.js.map
